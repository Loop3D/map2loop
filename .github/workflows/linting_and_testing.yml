name: Linting and Testing

on:
    [push]

jobs:
  linting:
    name: Linting
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff
          ruff check . --fix

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: style fixes by ruff and autoformatting by black"
 
          
  testing:
    name: Testing
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install GDAL
        run: |
          sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable
          sudo apt-get update
          sudo apt-get install -y libgdal-dev gdal-bin

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          python-version: '3.12'
          miniforge-version: latest
          activate-environment: test-env
          use-mamba: true
          environment-file: false
          auto-activate-base: false

      - name: Install dependencies
        shell: bash -l {0}
        run: |
            mamba install python=3.12 -y
            mamba install -c conda-forge gdal geopandas shapely networkx owslib beartype pytest scikit-learn -y
            pip install map2model loopprojectfile==0.2.2

      - name: Install map2loop
        shell: bash -l {0}
        run: |
            python -m pip install .

      - name: Run tests
        shell: bash -l {0}
        run: |
            python -c "import map2model" || echo "map2model not available, tests will use fallback mode"
            pytest -v